#!/usr/bin/env python3

"""
Generates plots for the Lanczos memory-computation trade-off experiment.

This script reads a CSV file produced by the `tradeoff.rs` runner and
creates two publication-quality plots:
1. Peak Memory Usage (RSS) vs. Number of Iterations (k).
2. Wall-Clock Time vs. Number of Iterations (k).

The plots are saved as PDF files for easy inclusion in LaTeX documents.
"""
import argparse
import pandas as pd
import matplotlib.pyplot as plt

def create_plots(input_csv_path: str, output_prefix: str):
    """
    Reads experiment data and generates memory and time plots.

    # Arguments

    * `input_csv_path` - Path to the input CSV file containing the results.

    * `output_prefix` - The base path and filename for the output plots.
                        For example, 'report/figures/tradeoff' will produce
                        'tradeoff_memory.pdf' and 'tradeoff_time.pdf'.
    """
    try:
        # Read the data using pandas.
        df = pd.read_csv(input_csv_path)
    except FileNotFoundError:
        print(f"Error: Input file not found at '{input_csv_path}'")
        return

    # Separate the dataframe into two based on the 'variant' column.
    df_standard = df[df['variant'] == 'standard'].copy()
    df_two_pass = df[df['variant'] == 'two-pass'].copy()

    # Set a professional plot style.
    plt.style.use('seaborn-v0_8-whitegrid')

    # --- 1. Memory Usage Plot ---
    fig_mem, ax_mem = plt.subplots(figsize=(8, 6))

    # Plot data for standard (one-pass) Lanczos.
    ax_mem.plot(
        df_standard["k"],
        df_standard["rss_kb"] / 1024,  # Convert KB to MB for readability
        label="Standard Lanczos (One-Pass)",
        marker='o',
        linestyle='-',
        color='C0'
    )
    # Plot data for two-pass Lanczos.
    ax_mem.plot(
        df_two_pass["k"],
        df_two_pass["rss_kb"] / 1024,
        label="Two-Pass Lanczos",
        marker='x',
        linestyle='--',
        color='C1'
    )

    ax_mem.set_xlabel("Number of Iterations (k)", fontsize=12)
    ax_mem.set_ylabel("Peak Memory Usage (MB)", fontsize=12)
    ax_mem.set_title("Memory Usage vs. Iteration Count", fontsize=14, fontweight='bold')
    ax_mem.legend(fontsize=11)
    ax_mem.tick_params(axis='both', which='major', labelsize=10)
    ax_mem.grid(True, which='both', linestyle='--', linewidth=0.5)

    # Ensure the y-axis starts at zero for better comparison.
    ax_mem.set_ylim(bottom=0)

    memory_plot_path = f"{output_prefix}_memory.pdf"
    fig_mem.savefig(memory_plot_path, bbox_inches='tight')
    print(f"Successfully saved memory plot to: {memory_plot_path}")

    # --- 2. Execution Time Plot ---
    fig_time, ax_time = plt.subplots(figsize=(8, 6))

    ax_time.plot(
        df_standard["k"],
        df_standard["time_s"],
        label="Standard Lanczos (One-Pass)",
        marker='o',
        linestyle='-',
        color='C0'
    )
    ax_time.plot(
        df_two_pass["k"],
        df_two_pass["time_s"],
        label="Two-Pass Lanczos",
        marker='x',
        linestyle='--',
        color='C1'
    )

    ax_time.set_xlabel("Number of Iterations (k)", fontsize=12)
    ax_time.set_ylabel("Wall-Clock Time (seconds)", fontsize=12)
    ax_time.set_title("Execution Time vs. Iteration Count", fontsize=14, fontweight='bold')
    ax_time.legend(fontsize=11)
    ax_time.tick_params(axis='both', which='major', labelsize=10)
    ax_time.grid(True, which='both', linestyle='--', linewidth=0.5)

    # Ensure the y-axis starts at zero.
    ax_time.set_ylim(bottom=0)

    time_plot_path = f"{output_prefix}_time.pdf"
    fig_time.savefig(time_plot_path, bbox_inches='tight')
    print(f"Successfully saved time plot to: {time_plot_path}")


def main():
    """Parses command-line arguments and runs the plotting function."""
    parser = argparse.ArgumentParser(
        description="Plot results for the Lanczos trade-off experiment."
    )
    parser.add_argument(
        "--input",
        type=str,
        required=True,
        help="Path to the input CSV file generated by the tradeoff runner."
    )
    parser.add_argument(
        "--output-prefix",
        type=str,
        required=True,
        help="Prefix for the output PDF plot files (e.g., 'report/figures/tradeoff')."
    )
    args = parser.parse_args()
    create_plots(args.input, args.output_prefix)

if __name__ == "__main__":
    main()
